/* CREATE MASTERKEY*/
if not exists (select * from sys.column_master_keys where name = 'Cmk_Cript_I4pro')
begin
	CREATE COLUMN MASTER KEY [Cmk_Cript_I4pro]
	WITH
	(
	    KEY_STORE_PROVIDER_NAME = N'MSSQL_CERTIFICATE_STORE',
	    KEY_PATH = N'CurrentUser/my/D8CDCC7BC22069DEC1FCF32A5C349FCD33424FAA'
	)
end
GO
	
/* criando a column encrypt keys */
if not exists (select 1 from sys.column_encryption_keys where name = 'ErpWsPCEK')
begin
	CREATE COLUMN ENCRYPTION KEY [ErpWsPCEK]
	WITH VALUES
	(
	    COLUMN_MASTER_KEY = [Cmk_Cript_I4pro],
	    ALGORITHM = 'RSA_OAEP'
		,    ENCRYPTED_VALUE = 0x016E000001630075007200720065006E00740075007300650072002F006D0079002F006400380063006400630063003700620063003200320030003600390064006500630031006600630066003300320061003500630033003400390066006300640033003300340032003400660061006100435052EEFF25542A375E23CC9E0BE2B79116313A2A14F3F3AE362B4075368EADB9EB3AB7BC19B14972204CD1E092B6DF0AC9C6BB0067F96AF7EED7C6360273B947EDAE5643932262E43D3C412B1F680929C263C9DD1839D86EDEBCCC6F2F307910CBD123ADB761BFD167F44C77BF6355114955DF371332D429A4DD79C9C51E02A781A977987947CAEF8FED3A30B4B3E9C8EE400F2F416289FE76DCC24B7D509D8ABA35C34959678CF31A704CD4E4C5105CA23CA09F4DD05AEABF413113E093FF7F398C859CA90C05F42DA5C43871DD0DDD95C555B524E342E6125DEA069C6ABF80F7A741B1ADCC73408B3A98C08CAEAC9325079F66256AC8835574FA5E38BCD634ED0BC71DE05EF61E1FEB4ACC1E62DEDDFFC5E86D2E6B3CBE1BEE22588FE29BA3AEB94FA46AF77C22AD7421F606836EC4BC1A3353019106E9B55E20A7DB72A06C63ADB4F438C191DCBA891FEF0F874AAF569C42730EF18E7E84754640D0EC37F48BA8E0455569E59F497849F9295962725D71769FE806B15556A7716341B7560B5E28323FB00846D4EEC0DF2C50339693EF29D83667EE88781FEB079460CB6A2FA49CD5418226D8465957DD5B95EECAF12B0AD436B40FE2F70F7E96A506E3ECACC94C4394A6D103532546541950D58D0057185BB024A98204006697BCB30CE8077CD2A39C7BAED5D76391294A35914B132C798173ED5AE4EDC7551D97F7C5B6
	)
end
GO

/* Create table */

if OBJECT_ID('wsp.t_trilha_detalhe') is not null
BEGIN
	drop table [wsp].[t_trilha_detalhe]
end 

GO

CREATE TABLE [wsp].[t_trilha_detalhe](
	[id_trilha_detalhe] [varchar](32) NOT NULL,
	[id_trilha_header] [varchar](32) NOT NULL,
	[nm_tp_objeto] [varchar](16) NOT NULL,
	[nm_objeto] [varchar](max) COLLATE Latin1_General_BIN2 ENCRYPTED WITH (COLUMN_ENCRYPTION_KEY = [ErpWsPCEK], ENCRYPTION_TYPE = Deterministic, ALGORITHM = 'AEAD_AES_256_CBC_HMAC_SHA_256') NULL,
	[nr_objeto_bytes] [bigint] NULL,
 
	CONSTRAINT [PK_t_trilha_detalhe] PRIMARY KEY CLUSTERED ([id_trilha_detalhe] ASC) WITH (FILLFACTOR = 80, STATISTICS_NORECOMPUTE = ON),
	CONSTRAINT [FK_t_trilha_detalhe_t_trilha_header] FOREIGN KEY ([id_trilha_header]) REFERENCES [wsp].[t_trilha_header]([id_trilha_header])
)

/* Consulta masterkeys CMK */
select * from sys.column_master_keys

/* Consulta columns keys CEK */ 
select * from sys.column_encryption_keys

/* Masterkey Encrypted by server  */	
select name,is_master_key_encrypted_by_server from sys.databases

/* Consulta colunas encrypted */
SELECT
    DB_NAME() AS [database],
    t.[name] AS [table],
    c.[name] AS [column],
    c.encryption_algorithm_name,
    c.[encryption_type],
    c.encryption_type_desc,
	cek.name
FROM
    sys.columns c
    JOIN sys.tables t 
	ON t.[object_id] = c.[object_id]
	left join sys.column_encryption_keys cek
	on c.column_encryption_key_id = cek.column_encryption_key_id
WHERE
    c.encryption_algorithm_name IS NOT NULL